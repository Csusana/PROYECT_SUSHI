{%extends 'base.html'%}
{%block content%}
		<!-- Start Hero Section -->
			<div class="hero">
				<div class="container">
					<div class="row justify-content-between">
						<div class="col-lg-5">
							<div class="intro-excerpt">
								<h1>Finalizar Compra</h1>
							</div>
						</div>
						<div class="col-lg-7">
							
						</div>
					</div>
				</div>
			</div>
		<!-- End Hero Section -->

		<div class="untree_co-section">
		    <div class="container">
		      <div class="row">
		        <div class="col-md-6 mb-5 mb-md-0">
		          <h2 class="h3 mb-3 text-white">Datos de Entrega</h2>
		          <div class="p-3 p-lg-5 border checkout-form">
		            <div class="form-group row">
		              <div class="col-md-6 mb-3">
		                <label for="c_fname" class="text-white">Nombre <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_fname" name="c_fname">
		              </div>
		              <div class="col-md-6 mb-3">
		                <label for="c_lname" class="text-white">Apellido <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_lname" name="c_lname">
		              </div>
		            </div>

		            <div class="form-group row mb-3">
		              <div class="col-md-12">
		                <label for="c_address" class="text-white">Dirección <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_address" name="c_address" placeholder="Calle, número, piso">
		              </div>
		            </div>

		            <div class="form-group row mb-3">
		              <div class="col-md-6">
		                <label for="c_email_address" class="text-white">Email <span class="text-danger">*</span></label>
		                <input type="email" class="form-control" id="c_email_address" name="c_email_address">
		              </div>
		              <div class="col-md-6">
		                <label for="c_phone" class="text-white">Teléfono <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_phone" name="c_phone">
		              </div>
		            </div>

                    <div class="form-group row mb-3">
		                    <div class="col-md-12">
                        <label for="c_order_notes" class="text-white">Notas del pedido</label>
                        <textarea name="c_order_notes" id="c_order_notes" cols="30" rows="5" class="form-control" placeholder="Instrucciones especiales para la entrega..."></textarea>
		              </div>
		            </div>
		          </div>
		        </div>
		        <div class="col-md-6">
		          <div class="row mb-5">
		            <div class="col-md-12">
		              <h2 class="h3 mb-3 text-white">Tu Pedido</h2>
		              <div class="p-3 p-lg-5 border checkout-form">
		                <table class="table site-block-order-table mb-5">
		                  <thead>
		                    <th>Producto</th>
		                    <th>Total</th>
		                  </thead>
		                  <tbody id="checkout-items">
		                    <!-- 购物车项目将通过JavaScript动态添加 -->
		                  </tbody>
		                  <tfoot>
		                    <tr>
                              <td class="text-white font-weight-bold">Subtotal</td>
                              <td class="text-white font-weight-bold" id="checkout-subtotal">$0.00</td>
		                    </tr>
		                    <tr>
                              <td class="text-white font-weight-bold">Envío</td>
                              <td class="text-white font-weight-bold">Gratis</td>
		                    </tr>
		                    <tr>
                              <td class="text-white font-weight-bold">Total</td>
                              <td class="text-white font-weight-bold" id="checkout-total">$0.00</td>
		                    </tr>
                          </tfoot>
		                </table>

		                <div class="border p-3 mb-3">
		                  <h3 class="h6 mb-0 text-white"><a class="d-block" data-bs-toggle="collapse" href="#collapsebank" role="button" aria-expanded="false" aria-controls="collapsebank">Transferencia Bancaria</a></h3>

		                  <div class="collapse" id="collapsebank">
		                    <div class="py-2">
		                      <p class="mb-0 text-white">Realiza tu pago directamente en nuestra cuenta bancaria. Por favor, usa tu ID de pedido como referencia de pago.</p>
		                    </div>
		                  </div>
		                </div>

		                <div class="border p-3 mb-3">
		                  <h3 class="h6 mb-0 text-white"><a class="d-block" data-bs-toggle="collapse" href="#collapsecheque" role="button" aria-expanded="false" aria-controls="collapsecheque">Pago con Tarjeta</a></h3>

		                  <div class="collapse" id="collapsecheque">
		                    <div class="py-2">
		                      <p class="mb-0 text-white">Paga con tarjeta de crédito o débito.</p>
		                    </div>
		                  </div>
		                </div>

		                <div class="border p-3 mb-5">
		                  <h3 class="h6 mb-0 text-white"><a class="d-block" data-bs-toggle="collapse" href="#collapsepaypal" role="button" aria-expanded="false" aria-controls="collapsepaypal">Efectivo en la Entrega</a></h3>

		                  <div class="collapse" id="collapsepaypal">
		                    <div class="py-2">
		                      <p class="mb-0 text-white">Paga al recibir tu pedido.</p>
		                    </div>
		                  </div>
		                </div>

		                <div class="form-group">
		                  <button class="pay-button" onclick="placeOrder()">FINALIZAR COMPRA</button>
		                </div>

		              </div>
		            </div>
		          </div>

		        </div>
		      </div>
		    </div>
		  </div>

		<script>
		  document.addEventListener('DOMContentLoaded', function() {
			// 从localStorage获取购物车数据
			const cart = JSON.parse(localStorage.getItem('cart')) || [];
			const checkoutItemsContainer = document.getElementById('checkout-items');
			const subtotalElement = document.getElementById('checkout-subtotal');
			const totalElement = document.getElementById('checkout-total');
			
			// 从localStorage获取配送日期和时间
			const deliveryDate = localStorage.getItem('deliveryDate');
			const deliveryTime = localStorage.getItem('deliveryTime');
			
			// 如果没有配送信息，返回购物车页面
			if (!deliveryDate || !deliveryTime) {
			  alert('Por favor, seleccione una fecha y hora de entrega en la página del carrito.');
			  window.location.href = '/cart';
			  return;
			}
			
			// 更新订单显示
			function updateOrderDisplay() {
			  // 清空容器
			  checkoutItemsContainer.innerHTML = '';
			  
			  let subtotal = 0;
			  
			  // 如果购物车为空，显示提示信息
			  if (cart.length === 0) {
				checkoutItemsContainer.innerHTML = '<tr><td colspan="2" class="text-center text-white">Su carrito está vacío</td></tr>';
				subtotalElement.textContent = '$0.00';
				totalElement.textContent = '$0.00';
				return;
			  }
			  
			  // 为每个购物车项目创建一行
			  cart.forEach((item) => {
				const itemTotal = item.price * item.quantity;
				subtotal += itemTotal;
				
				const tr = document.createElement('tr');
				tr.innerHTML = `
				  <td class="text-white">${item.name} <strong class="mx-2">x</strong> ${item.quantity}</td>
				  <td class="text-white">$${itemTotal.toFixed(2)}</td>
				`;
				
				checkoutItemsContainer.appendChild(tr);
			  });
			  
			  // 更新总计
			  subtotalElement.textContent = '$' + subtotal.toFixed(2);
			  totalElement.textContent = '$' + subtotal.toFixed(2);
			}
			
			// 初始化显示
			updateOrderDisplay();
		  });
		  
		  function placeOrder() {
			// 获取表单数据
			const firstName = document.getElementById('c_fname').value;
			const lastName = document.getElementById('c_lname').value;
			const address = document.getElementById('c_address').value;
			const email = document.getElementById('c_email_address').value;
			const phone = document.getElementById('c_phone').value;
			const notes = document.getElementById('c_order_notes').value;
			
			// 简单的表单验证
			if (!firstName || !lastName || !address || !email || !phone) {
			  alert('Por favor, complete todos los campos obligatorios');
			  return;
			}
			
			// 获取购物车数据
			const cart = JSON.parse(localStorage.getItem('cart')) || [];
			
			if (cart.length === 0) {
			  alert('Su carrito está vacío');
			  return;
			}
			
			// 保存用户信息到localStorage
			const customerInfo = {
			  firstName,
			  lastName,
			  address,
			  email,
			  phone,
			  notes,
			  orderNumber: 'SC-' + Math.floor(10000 + Math.random() * 90000) // 生成随机订单号
			};
			
			localStorage.setItem('customerInfo', JSON.stringify(customerInfo));
			
			// 跳转到感谢页面
			window.location.href = '/thankyou';
		  }
		</script>
		{%endblock%}